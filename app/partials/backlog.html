<header class="header-container" ng-include="'/partials/header.html'"></header>
<div class="middle-container backlog-content row-fluid">
    <div class="span8" ng-controller="BacklogUserStoriesController">
        <div class="graphics-container">
            <div class="user-story-stats" url="">
                <div class="progress-box">
                    <div class="progress progress-success">
                        <div class="bar" style="width: {{ (projectStats.closed_points * 100) / projectStats.total_points|number:1}}%;"></div>
                    </div>
                    <div class="progress-indicator indicator">{{ (projectStats.closed_points * 100) / projectStats.total_points|number:1 }}%</div>
                    <div class="progress-help help">completed</div>
                </div>
                <div class="stats-box">
                    <div class="item">
                        <div class="indicator">{{ projectStats.total_points }}</div>
                        <div class="help">project points</div>
                    </div>

                    <div class="item">
                        <div class="indicator">{{ projectStats.defined_points }}</div>
                        <div class="help">defined points</div>
                    </div>

                    <div class="item">
                        <div class="indicator">{{ projectStats.closed_points }}</div>
                        <div class="help">closed points</div>
                    </div>
                </div>
                <a class="button new-us-story" data-icon="m"
                    ng-click="openCreateUserStoryForm()">
                    New user story
                </a>
                <a class="button show-hide-graphics" data-icon="k" ng-show="milestones.length > 0" gm-ninja-graph>
                    <!-- Show graphics -->
                </a>
            </div>
            <div class="graph-box">
                <div id="graphs">
                    <div id="burndown" gm-backlog-graph></div>
                </div>
            </div>
        </div>

        <div class="filters-container" ng-show="tags">
            <div class="filters-bar-sbox">
                <div class="title-sbox">
                    <a data-icon="B" href="" ng-class="{active: filtersOpened}" ng-click="filtersOpened=!filtersOpened">Filters</a>
                </div>
                <div class="filters-visual-box" ng-show="filtersOpened">
                    <div class="tags-list-sbox">
                        <div class="tag" ng-repeat="tag in tags" ng-click="selectTag(tag)"
                                ng-class="{selected: tag.selected}" gm-colorize-tag>
                            <div class="name">{{ tag.name }}</div>
                            <div class="count">{{ tag.count }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="filters-selected-box"></div>
        </div>

        <div class="us-container">
            <div class="us-table-list">
                <div class="flex-header">
<!--
                    <div class="us-check"></div>
-->
                    <div class="us-title">User Story</div>
                    <div class="us-points">Points</div>
                    <div class="us-options">Options</div>
                </div>
                <div class="flex-header second">
<!--
                    <div class="us-check"></div>
-->
                    <div class="us-title">
                        <div class="list-options">
                            <div class="option">
                                <input id="show_tags" type="checkbox" ng-model="showTags"></input>
                                <label for="show_tags">Show tags</label>
                            </div>
                            <div class="option">
                                <input id="show_total_points" type="checkbox" ng-model="showTotalPoints"></input>
                                <!-- TODO: total points col -->
                                <label for="show_total_points">Show total points (TODO)</label>
                            </div>
                            <div class="option" ng-show="selectedUserStories">
                                <a href="" class="add-selected-us" data-icon="A"
                                    ng-click="moveSelectedUserStoriesToCurrentSprint()">Add selected US ({{ selectedStoryPoints }} points) to current sprint</a>
                            </div>
                        </div>
                    </div>
                    <div class="us-points">
                        <div ng-repeat="item in constants.computableRolesList" class="role-point">
                            {{ item.name }}
                        </div>
                    </div>
                    <div class="us-options"></div>
                </div>
                <div class="flex-body" gm-sortable=".sprints-box .flex-body" ng-model="unassingedUs" gm-doomline>
                    <div class="us-item nga-us-item" ng-repeat="us in unassingedUs|onlyVisible"
                            gm-sortable-index="{{$index}}" ng-class="{selected:us.selected}">
                        <div class="us-check">
                            <input type="checkbox" ng-model="us.selected" ng-change="changeUserStoriesSelection()"></input>
                        </div>
                        <div class="us-title">
                            <div class="title">{{ us.subject|truncate:60 }}</div>
                            <div class="tags" ng-hide="!showTags">
                                <span ng-repeat="tag in us.tags" class="label" gm-colorize-tag>{{ tag }}</span>
                            </div>
                        </div>
                        <div class="us-points">
                            <!--
                            <a href="" gm-popover="saveUsPoints(us, selectedId)"
                                data-tmpl="#points-popover" data-auto-hide="true">{{ constants.points[us.points].name }}</a>
                            -->
                            <div ng-repeat="role in constants.computableRolesList" class="role-point"
                                    gm-popover="saveUsPoints(us, role, selectedId)"
                                    data-tmpl="#points-popover" data-auto-hide="true">
                                {{ constants.points[us.points[role.id]].name }}
                            </div>
                        </div>
                        <div class="us-options extra-options">
                            <a class="btn-small-preview" data-icon="l" gm-popover data-tmpl="#us-preview-popover" data-auto-hide="true">
                                <span class="help-box">Preview</span>
                            </a>
                            <a class="btn-small-edit" data-icon="j" href="{{ urls.userStoryUrl(projectId, us.id) }}">
                                <span class="help-box">Edit</span>
                            </a>
                            <a class="btn-small-remove" data-icon="h" gm-popover="removeUs(us)"
                                data-tmpl="#us-remove-popover">
                                <span class="help-box">Remove</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="milestones span4" ng-controller="BacklogMilestonesController" ng-init="sprintFormOpened=false">
        <div class="header-box">
            <div class="title-sbox">
                <div class="title">{{ project.total_milestones }}</div>
                <div class="help">sprints <br />planned</div>
            </div>
            <a href="" data-icon="q" class="button new-sprint" ng-click="sprintFormOpened=!sprintFormOpened">New sprint</a>
        </div>

        <div class="milestone-form-box nga-milestone" ng-show="sprintFormOpened">
            <form action="" gm-checksley-form="sprintSubmit()">
                <fieldset>
                    <label for="name">Sprint name:</label>
                    <input type="text" data-required="true" ng-model="form.name"
                           name="name" placeholder="Sprint name..."></input>
                </fieldset>

                <fieldset>
                    <div class="subfield">
                        <label for="estimated_start">Estimated start:</label>
                        <input type="text" gm-kalendae name="estimated_start"
                               ng-model="form.estimated_start"></input>
                    </div>
                    <div class="subfield">
                        <label for="estimated_finish">Estimated finish</label>
                        <input type="text" gm-kalendae name="estimated_finish"
                               ng-model="form.estimated_finish"></input>
                    </div>
                </fieldset>
                <div class="btn-group">
                    <input type="submit" class="button button-success"
                           gm-checksley-submit-button value="Save" />
                    <a href="" class="button" ng-click="sprintFormOpened=false">Close</a>
                </div>
            </form>
        </div>

        <!-- TODO: iocaine
        <div class="project-extras">
            <div class="iocaine-powder" data-icon="r">5 <span>iocaine doses</span></div>
            <div class="labor-force" data-icon="s">90% <span>labor force</span></div>
        </div>
        -->

        <div class="sprints-box">
            <p class="sprints-box-title">Sprints</p>
            <p class="empty" ng-show="milestones.length == 0">
                There isn't Sprints. Create a new one.
            </p>
            <div class="sprint-sbox" ng-repeat="ml in milestones"
                 ng-controller="BacklogMilestoneController"
                 ng-class="{first: $first}" ng-mouseover="showEditOption=true"
                 ng-mouseout="showEditOption=false">
                <div class="header">
                    <div class="title">
                        <a class="name" href="{{ urls.taskboardUrl(projectId, ml.id) }}">
                            {{ ml.name }}
                        </a>
                        <a class="edit" href="" ng-click="showEditForm(ml.id)"
                           ng-show="showEditOption" data-icon="d"></a>
                        <span>from {{ ml.estimated_start|momentFormat:"L" }} to {{ ml.estimated_finish|momentFormat:"L" }}</span>
                    </div>
                    <div class="stats">
                        <div class="sprint-progress">
                            <div class="progress progress-success">
                                <div class="bar" style="width: {{ stats.percentage }}%"></div>
                            </div>
                            <div class="progress-indicator">{{ stats.percentage }}%</div>
                        </div>
                        <div class="sprint-status">
                            <div class="item">
                                <div class="indicator">{{ stats.total }}</div>
                                <div class="help">total</div>
                            </div>
                            <div class="item">
                                <div class="indicator">{{ stats.closed }}</div>
                                <div class="help">closed</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="body">
                    <div class="us-list" ng-hide="editFormOpened">
                        <div class="us-table-list">
                            <div class="flex-body" gm-sortable=".us-container .flex-body"
                                    ng-model="milestones[$index].user_stories">
                                <div class="us-item" ng-repeat="us in ml.user_stories">
                                    <div class="us-title">{{ us.subject|truncate:50 }}</div>
                                    <div class="us-points">{{ us.total_points }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="milestone-edit-form-box" ng-show="editFormOpened">
                    <form action="" gm-checksley-form="submit()">
                        <fieldset>
                            <label>Sprint name:</label>
                            <input type="text" data-required="true" ng-model="ml.name"
                                name="name" placeholder="Sprint name..."></input>
                        </fieldset>

                        <fieldset>
                            <div class="subfield">
                                <label>Estimated start:</label>
                                <input type="text" gm-kalendae data-required="true"
                                       name="estimated_start"
                                       ng-model="ml.estimated_start"></input>
                            </div>
                            <div class="subfield">
                                <label>Estimated finish</label>
                                <input type="text" gm-kalendae data-required="true"
                                       name="estimated_finish"
                                       ng-model="ml.estimated_finish"></input>
                            </div>
                        </fieldset>
                        <div class="btn-group">
                            <input type="submit" class="button button-success"
                                   gm-checksley-submit-button value="Save" />
                            <a href="" class="button" ng-click="closeEditForm()">Close</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- user story form -->
<div id="userstory-modalform"
    gm-modal="user-story-form"
    ng-show="formOpened"
    ng-controller="BacklogUserStoryModalController">

    <div class="new-us-modal modal">
        <form class="inline-form us-form" gm-checksley-form="submit()">
            <div class="modal-header" ng-switch on="context.type">
                <h3 ng-switch-when="create">Create user story</h3>
                <h3 ng-switch-when="edit">Modify user story</h3>
            </div>
            <div class="modal-body">
                <fieldset class="fieldset-row">
                    <fieldset>
                        <label>Subject</label>
                        <input class="subject" type="text" ng-model="form.subject" data-required="true"
                               name="subject" placeholder="A descriptive name..." data-maxlength="500"></input>
                    </fieldset>
                </fieldset>
                <div class="fieldset-row" gm-role-points-edition></div>
                <div class="fieldset-row clearfix status-tags">
                    <fieldset>
                        <label>Status</label>
                        <select class="status" name="status" ng-model="form.status"
                            data-type="number" data-required="true"
                            data-error-message="This field is required."
                            ng-options="c.id as c.name for c in constants.usStatusesList|orderBy:'order'"></select>
                        </select>
                    </fieldset>
                    <fieldset>
                        <label>Tags</label>
                        <input type="text" class="tags" name="tags" value=""
                               gm-tags-input ng-model="form.tags"
                               placeholder="Ex: backend, backoffice, ecommerce..."></input>
                    </fieldset>
                </div>
                <fieldset class="fieldset-row">
                    <label>Description</label>
                    <textarea class="description" name="description"
                              placeholder="A good description..."
                              ng-model="form.description"></textarea>
                </fieldset>
                <div class="fieldset-row">
                    <input type="checkbox" id="client-requirement"
                           ng-model="form.client_requirement" name="client_requirement"/>
                    <label for="client-requirement">Client Requirement</label>
                    <input type="checkbox"id="team-requirement"
                           ng-model="form.team_requirement" name="team_requirement">
                    <label for="team-requirement" >Team Requirement</label>
                </div>
            </div>
            <div class="modal-footer">
                <input type="submit" class="button button-success"
                       gm-checksley-submit-button value="Save" />
                <a href="" class="button button-cancel" ng-click="close()">Close</a>
            </div>
        </form>
    </div>
</div>

<script type="text/template" id="points-popover">
    <div class="us-points-popover">
        <ul>
            <li class="item btn-accept" ng-repeat="obj in constants.pointsList" data-id="{{ obj.id }}">
                <a href="">{{ obj.name }}</a>
            </li>
        </ul>
    </div>
</script>

<script type="text/template" id="us-preview-popover">
    <div class="us-preview-popover">
        <section>
            <strong>Subject:</strong><br />{{ us.subject }}
        </section>
        <section>
            <strong>Description:</strong>
            <p>{{ us.description }}</p>
        </section>
    </div>
</script>

<script type="text/template" id="us-remove-popover">
    <div class="us-remove-popover">
        <section>
            <p>Are you sure you want to delete this user story:
                <strong>{{ us.subject }}</strong></p>
        </section>
        <section>
            <input type="button" class="button button-success" value="Delete" />
            <input type="button" class="button button-delete" value="Cancel" />
        </section>
    </div>
</script>
